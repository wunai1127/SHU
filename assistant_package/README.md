# Assistant Extraction Package v3 (English Version)

## Important Updates

**CRITICAL CHANGE**: This package now extracts in **ENGLISH** (not Chinese).

### What Changed from v2

1. **Schema**: Now using `english_medical_kg_schema.json`
2. **Prompts**: All extraction prompts are in English
3. **Output**: Entities and relations will be in English as they appear in source text

## Data Assignment

| Location | Range | Count | Checkpoint File |
|----------|-------|-------|----------------|
| Main Machine | 1-12216 | 12,216 articles | extraction_checkpoint.json |
| **Assistant** | **18325-24432** | **6,108 articles** | assistant_checkpoint.json |

## Quick Start (5 Steps)

### 1. Extract Package

```bash
tar -xzf assistant_package_v3.tar.gz
cd assistant_package
```

### 2. Install Dependencies (3 packages only)

```bash
pip install openai pyyaml httpx
```

**Note**: Do NOT run `pip install -r requirements.txt` (will try to install heavy packages like spacy)

### 3. Configure API Key

Edit `automated_kg_pipeline/config.yaml`:

```yaml
llm:
  deepseek:
    api_key: "sk-your-3rd-api-key"  # ‚Üê Change this
```

**Important**: Must use the 3rd key (main machine uses 1st key)

### 4. Create Directories

```bash
mkdir -p logs
mkdir -p cache/llm_raw_outputs
mkdir -p cache/parsed_triples
```

### 5. Start Extraction

```bash
# Option 1: Foreground (recommended for testing)
python3 automated_kg_pipeline/assistant_extract.py

# Option 2: Background
nohup python3 -u automated_kg_pipeline/assistant_extract.py > logs/assistant_extraction.log 2>&1 &

# View real-time log
tail -f logs/assistant_extraction.log
```

## Expected Output

When running, you should see:

```
============================================================
Assistant Knowledge Extraction - Processing 18325-24432
============================================================
Total articles: 6108 (second half, ~1/4)
Processed: 0
Remaining: 6108
Start time: 2026-01-09T...
============================================================

[18325/24432] Processing article: ...
  Text length: ... characters
```

## Example English Output

**Correct** (entities and relations in English):
```json
{
  "entities": [
    {"name": "heart transplantation", "type": "surgical_procedure"},
    {"name": "daratumumab", "type": "medication"},
    {"name": "anti-HLA sensitization", "type": "risk_factor"}
  ],
  "relations": [
    {"head": "anti-HLA sensitization", "relation": "causes", "tail": "antibody-mediated rejection"}
  ]
}
```

**Wrong** (would be Chinese - old version):
```json
{
  "entities": [
    {"name": "ÂøÉËÑèÁßªÊ§ç", "type": "ÊâãÊúØÊ≠•È™§"},  ‚ùå Should be in English
    ...
  ]
}
```

## Monitor Progress

### Check Progress

```bash
# Option 1: View log
tail -f logs/assistant_extraction.log

# Option 2: Count files
ls cache/parsed_triples/ | wc -l

# Option 3: Check checkpoint
cat cache/assistant_checkpoint.json
```

### Expected Progress

- **Hour 1**: ~250 articles (4%)
- **Hour 3**: ~750 articles (12%)
- **Hour 6**: ~1500 articles (25%)
- **Hour 12**: ~3000 articles (50%)
- **Hour 17**: 6108 articles complete (100%)

## Troubleshooting

### Q1: SSL Certificate Error
```
TLS_error:CERTIFICATE_VERIFY_FAILED
```
**Solution**: Script already disables SSL verification, ignore this

### Q2: API Rate Limiting (503/429)
```
HTTP/1.1 503 Service Unavailable
```
**Solution**: Script auto-retries (1s‚Üí3s‚Üí5s‚Üí10s‚Üí30s‚Üí60s‚Üí2min‚Üí5min‚Üí10min)

### Q3: Insufficient Balance
```
Insufficient balance! Progress saved
```
**Solution**:
1. Recharge DeepSeek account
2. Run the same command
3. Will automatically resume from checkpoint

### Q4: Process Stopped Unexpectedly

**Check**:
```bash
ps aux | grep assistant_extract
tail -50 logs/assistant_extraction.log
```

**Restart**:
```bash
python3 automated_kg_pipeline/assistant_extract.py
# Will automatically resume from last checkpoint
```

## Output Files

### Files Generated by Assistant

```
cache/
‚îú‚îÄ‚îÄ llm_raw_outputs/         # ~6108 raw LLM outputs
‚îú‚îÄ‚îÄ parsed_triples/          # ~6108 parsed triples
‚îî‚îÄ‚îÄ assistant_checkpoint.json # Checkpoint (for resumption)

logs/
‚îî‚îÄ‚îÄ assistant_extraction.log  # Run log
```

### Shared with Main Machine

- `cache/llm_raw_outputs/` - All raw outputs
- `cache/parsed_triples/` - All triples

**Note**: Caches merge automatically, no conflicts (named by article_id)

## Completion Indicator

When assistant completes, you should see:

```
============================================================
Current Progress
============================================================
Processed articles: 6108/6108
Completion: 100.00%
Total entities: ~52,000
Total relations: ~44,000
Errors: <50
============================================================
```

**Then notify main machine to merge data**.

## Cost Estimate

- **Articles**: 6,108
- **Token consumption**: ~4.9M tokens
- **Estimated cost**: ~5 RMB
- **Recommended recharge**: 10 RMB (with buffer)

## Contact

If you encounter issues:
1. Screenshot last 50 lines of log
2. Send `cache/assistant_checkpoint.json` content
3. Explain specific error message

---

**Good luck!** üöÄ

Estimated 17 hours to complete, plus main machine's 25 hours, **~25 hours total for all extraction**.
