# æ¶æ„é€‚é…åˆ†æï¼šä»å¿ƒè„ç§»æ¤é¢„æµ‹è½¬å‘å¿ƒè„çŒæ³¨ç­–ç•¥é¢„æµ‹

## 0. ä»»åŠ¡è½¬å‹æ€»ç»“

### åŸä»»åŠ¡
- **ç›®æ ‡**: å¿ƒè„ç§»æ¤æ‰‹æœ¯ç»“æœé¢„æµ‹ï¼ˆä¾›å¿ƒ-å—ä½“åŒ¹é…ã€æœ¯åå¹¶å‘ç—‡é£é™©ï¼‰
- **æ ¸å¿ƒé¢„æµ‹**: ç§»æ¤æˆåŠŸç‡ã€PGDé£é™©ã€1å¹´/5å¹´ç”Ÿå­˜ç‡
- **å…³é”®å› ç´ **: ä¾›ä½“ç‰¹å¾ã€å—ä½“ç‰¹å¾ã€åŒ¹é…åº¦ã€ç¼ºè¡€æ—¶é—´

### æ–°ä»»åŠ¡
- **ç›®æ ‡**: å¿ƒè„çŒæ³¨ç­–ç•¥é¢„æµ‹ä¸çŒæ³¨ä¸­é—®é¢˜é¢„è­¦
- **æ ¸å¿ƒé¢„æµ‹**:
  1. **çŒæ³¨ç»“æœé¢„æµ‹**: ç»™å®šæ‹ŸçŒæ³¨ç­–ç•¥ï¼Œé¢„æµ‹çŒæ³¨åå¿ƒè„è´¨é‡
  2. **çŒæ³¨ä¸­é—®é¢˜é¢„è­¦**: å®æ—¶ç›‘æµ‹çŒæ³¨æ•°æ®ï¼Œé¢„æµ‹å¯èƒ½å‡ºç°çš„é—®é¢˜
  3. **ä»‹å…¥æªæ–½æ¨è**: å½“å‡ºç°é—®é¢˜æ—¶ï¼Œæ¨èæœ€ä¼˜ä»‹å…¥æªæ–½

### å…³é”®å·®å¼‚
| ç»´åº¦ | å¿ƒè„ç§»æ¤é¢„æµ‹ | å¿ƒè„çŒæ³¨ç­–ç•¥é¢„æµ‹ |
|------|-------------|----------------|
| **æ—¶é—´å°ºåº¦** | æœ¯åæ•°æœˆ-æ•°å¹´ | çŒæ³¨ä¸­æ•°åˆ†é’Ÿ-æ•°å°æ—¶ |
| **æ•°æ®ç±»å‹** | é™æ€ç‰¹å¾ä¸ºä¸» | **æ—¶åºæ•°æ®ä¸ºä¸»** |
| **é¢„æµ‹ç›®æ ‡** | é•¿æœŸç”Ÿå­˜ç‡ | **å®æ—¶çŒæ³¨è´¨é‡ã€çŸ­æœŸå¿ƒè„åŠŸèƒ½** |
| **å†³ç­–é¢‘ç‡** | æ‰‹æœ¯å‰ä¸€æ¬¡æ€§å†³ç­– | **çŒæ³¨ä¸­å¤šæ¬¡åŠ¨æ€å†³ç­–** |
| **çŸ¥è¯†æ¥æº** | ä¸´åºŠç ”ç©¶æ–‡çŒ® | **æ“ä½œæ‰‹å†Œ+æ—¶åºç›‘æµ‹æ•°æ®** |

---

## 1. æ•´ä½“æ¶æ„æ˜¯å¦éœ€è¦æ”¹ï¼Ÿ

### ç»“è®ºï¼š**æ¶æ„æ ¸å¿ƒä¸å˜ï¼Œä½†éœ€è¦3ä¸ªå…³é”®æ‰©å±•**

### 1.1 ä¿æŒä¸å˜çš„æ¶æ„ç»„ä»¶

#### âœ… Multi-Agentæ¡†æ¶ï¼ˆLangGraphï¼‰
- **Medical Expert Agent**: ç»§ç»­è´Ÿè´£ç†è§£åŒ»å­¦æ¦‚å¿µï¼ˆçŒæ³¨æ¶²ç±»å‹ã€è¡€æ°”æŒ‡æ ‡ã€ç‚ç—‡å› å­ï¼‰
- **RAG Agent**: ä»KGæ£€ç´¢ç›¸å…³çŒæ³¨ç­–ç•¥æ¡ˆä¾‹
- **Analyzer Agent**: åŒè·¯å¾„æ¨ç†ï¼ˆGNN+LLMï¼‰
- **WorkerCoordinator**: å¤šæ™ºèƒ½ä½“åè°ƒ

#### âœ… åŒå±‚å›¾ç»“æ„
- **Concept Layer**:
  - çŒæ³¨ç­–ç•¥ç±»å‹ï¼ˆHTKæ¶²ã€UWæ¶²ã€Celsioræ¶²ã€DCDçŒæ³¨ï¼‰
  - é£é™©å› å­ï¼ˆé«˜é’¾è¡€ç—‡ã€é…¸ä¸­æ¯’ã€çŒæ³¨ä¸è¶³ï¼‰
  - å¹¶å‘ç—‡ï¼ˆå¿ƒè‚Œæ°´è‚¿ã€å†çŒæ³¨æŸä¼¤ï¼‰
  - ä»‹å…¥æªæ–½ï¼ˆè°ƒæ•´çŒæ³¨å‹ã€è¡¥å……è¥å…»æ¶²ã€æ¸©åº¦æ§åˆ¶ï¼‰
- **Instance Layer**:
  - **PerfusionCase** (æ–°å¢): å•æ¬¡çŒæ³¨æ¡ˆä¾‹èŠ‚ç‚¹
  - **HeartInstance** (æ–°å¢): å¾…çŒæ³¨å¿ƒè„èŠ‚ç‚¹
  - ä¿ç•™åŸæœ‰Case/Donor/Recipientï¼ˆç”¨äºç§»æ¤é¢„æµ‹ï¼‰

#### âœ… å››å±‚å¤„ç†æ¶æ„
- Layer 1: LLMæŠ½å–çŸ¥è¯†ï¼ˆæ–‡çŒ®+æ“ä½œæ‰‹å†Œï¼‰
- Layer 2-4: æœ¬åœ°è§£æã€åå¤„ç†ã€å›¾å¢å¼º

#### âœ… Neuro-Symbolicæ¨ç†
- GNNè·¯å¾„: æ•°å€¼ç‰¹å¾ï¼ˆè¡€æ°”pHã€ä¹³é…¸ã€PO2ï¼‰â†’ çŒæ³¨è´¨é‡é¢„æµ‹
- LLMè·¯å¾„: æ–‡æœ¬æè¿°ï¼ˆ"ä¸»åŠ¨è„‰æ ¹éƒ¨ç‹­çª„"ï¼‰â†’ çŒæ³¨ç­–ç•¥è°ƒæ•´å»ºè®®

---

### 1.2 éœ€è¦æ‰©å±•çš„3ä¸ªå…³é”®æ¨¡å—

#### ğŸ”§ æ‰©å±•1: **æ—¶åºæ•°æ®å¤„ç†æ¨¡å—** (NEW)

**ä¸ºä»€ä¹ˆéœ€è¦**: çŒæ³¨ä¸­æ•°æ®æ˜¯æ—¶åºçš„ï¼ˆæ¯5åˆ†é’Ÿä¸€æ¬¡è¡€æ°”åˆ†æï¼‰ï¼Œè€Œç§»æ¤é¢„æµ‹æ˜¯é™æ€ç‰¹å¾

**æŠ€æœ¯æ–¹æ¡ˆ**:
```python
class TemporalPerfusionGNN:
    """æ—¶åºå›¾ç¥ç»ç½‘ç»œ - å¤„ç†çŒæ³¨ä¸­åŠ¨æ€æ•°æ®"""

    def __init__(self):
        # æ—¶åºç¼–ç å™¨ï¼šLSTM/Transformerå¤„ç†æ—¶åºç‰¹å¾
        self.temporal_encoder = nn.LSTM(
            input_size=20,  # è¡€æ°”+ç‚ç—‡å› å­+çŒæ³¨å‚æ•°
            hidden_size=64,
            num_layers=2
        )

        # å›¾å·ç§¯å±‚ï¼šå¤„ç†å¿ƒè„-çŒæ³¨ç­–ç•¥-ç›‘æµ‹æŒ‡æ ‡çš„å›¾ç»“æ„
        self.gnn = GraphSAGE(
            in_channels=64,
            hidden_channels=128,
            num_layers=3
        )

    def forward(self, temporal_features, graph):
        """
        temporal_features: [batch, time_steps, features]
          - time_steps: çŒæ³¨å¼€å§‹åçš„æ—¶é—´ç‚¹ï¼ˆ0, 5min, 10min, ...ï¼‰
          - features: [pH, PO2, PCO2, lactate, K+, Na+,
                      IL-6, IL-8, TNF-Î±, çŒæ³¨å‹, æµé‡, æ¸©åº¦, ...]

        graph: å¿ƒè„ç‰¹å¾èŠ‚ç‚¹ + çŒæ³¨ç­–ç•¥èŠ‚ç‚¹ + æ—¶åºç›‘æµ‹èŠ‚ç‚¹
        """
        # 1. æ—¶åºç¼–ç 
        h_temporal, (hn, cn) = self.temporal_encoder(temporal_features)

        # 2. å›¾å·ç§¯ï¼ˆèåˆå¿ƒè„ç‰¹å¾ + çŒæ³¨ç­–ç•¥ + æ—¶åºçŠ¶æ€ï¼‰
        h_graph = self.gnn(graph.x, graph.edge_index)

        # 3. èåˆé¢„æµ‹
        return self.predict_head(torch.cat([hn[-1], h_graph], dim=-1))
```

**ä¸ç°æœ‰æ¶æ„çš„é›†æˆ**:
- åœ¨ `Analyzer Agent` ä¸­æ–°å¢ `TemporalPerfusionGNN` ä½œä¸ºç¬¬ä¸‰æ¡æ¨ç†è·¯å¾„
- ä¿ç•™åŸæœ‰ `GraphSAGE`ï¼ˆç”¨äºé™æ€ç§»æ¤é¢„æµ‹ï¼‰
- è¾“å‡º:
  - ä¸‹ä¸€ä¸ªæ—¶é—´ç‚¹çš„é¢„æœŸè¡€æ°”æŒ‡æ ‡
  - çŒæ³¨è´¨é‡è¯„åˆ†ï¼ˆ0-100ï¼‰
  - é£é™©é¢„è­¦ï¼ˆæ˜¯å¦éœ€è¦ä»‹å…¥ï¼‰

---

#### ğŸ”§ æ‰©å±•2: **çŒæ³¨çŸ¥è¯†å›¾è°±æ¨¡å—** (Schema Extension)

**Schemaæ‰©å±•éœ€æ±‚**:

```json
{
  "æ–°å¢å®ä½“ç±»å‹": {
    "çŒæ³¨ç­–ç•¥": {
      "properties": {
        "ç­–ç•¥åç§°": "string",  // "HTKé¡ºè¡ŒçŒæ³¨", "UWé€†è¡ŒçŒæ³¨"
        "çŒæ³¨æ¶²ç±»å‹": "enum[HTK, UW, Celsior, Custodiol]",
        "çŒæ³¨æ¸©åº¦": "float",   // 4Â°C, 20Â°C
        "çŒæ³¨å‹åŠ›": "float",   // mmHg
        "çŒæ³¨æµé‡": "float",   // ml/min
        "çŒæ³¨æ—¶é•¿": "float"    // åˆ†é’Ÿ
      }
    },

    "çŒæ³¨ç›‘æµ‹æŒ‡æ ‡": {
      "properties": {
        "æŒ‡æ ‡ç±»å‹": "enum[è¡€æ°”, ç‚ç—‡å› å­, ç”ŸåŒ–æŒ‡æ ‡]",
        "æ­£å¸¸èŒƒå›´": "tuple<float, float>",
        "å±é™©é˜ˆå€¼": "float",
        "é‡‡æ ·é¢‘ç‡": "string"  // "æ¯5åˆ†é’Ÿ"
      }
    },

    "ä»‹å…¥æªæ–½": {
      "properties": {
        "æªæ–½ç±»å‹": "enum[è°ƒæ•´çŒæ³¨å‚æ•°, è¡¥å……è¯ç‰©, æ›´æ¢çŒæ³¨æ¶², æ¸©åº¦æ§åˆ¶]",
        "è§¦å‘æ¡ä»¶": "string",  // "pH < 7.2"
        "å…·ä½“æ“ä½œ": "string",
        "é¢„æœŸæ•ˆæœ": "string"
      }
    },

    "çŒæ³¨ç»“æœ": {
      "properties": {
        "è´¨é‡è¯„åˆ†": "float",   // 0-100
        "æ˜¯å¦å¯ç”¨": "boolean",
        "åŠŸèƒ½æŒ‡æ ‡": {
          "æ”¶ç¼©åŠ›": "enum[ä¼˜ç§€, è‰¯å¥½, ä¸€èˆ¬, å·®]",
          "å¿ƒå¾‹": "enum[çª¦æ€§, å¿ƒæˆ¿é¢¤åŠ¨, åœæ]",
          "å† è„‰è¡€æµ": "enum[é€šç•…, éƒ¨åˆ†é˜»å¡, ä¸¥é‡é˜»å¡]"
        }
      }
    }
  },

  "æ–°å¢å…³ç³»ç±»å‹": {
    "APPLIES_STRATEGY": {
      "è¯´æ˜": "PerfusionCase -> çŒæ³¨ç­–ç•¥",
      "properties": {"ç­–ç•¥æ‰§è¡Œæ—¶é—´": "timestamp"}
    },
    "MONITORS": {
      "è¯´æ˜": "PerfusionCase -> çŒæ³¨ç›‘æµ‹æŒ‡æ ‡",
      "properties": {
        "æµ‹é‡æ—¶é—´": "timestamp",
        "æµ‹é‡å€¼": "float",
        "æ˜¯å¦å¼‚å¸¸": "boolean"
      }
    },
    "TRIGGERS_INTERVENTION": {
      "è¯´æ˜": "çŒæ³¨ç›‘æµ‹æŒ‡æ ‡ -> ä»‹å…¥æªæ–½",
      "properties": {
        "è§¦å‘é˜ˆå€¼": "float",
        "è§¦å‘æ—¶é—´": "timestamp"
      }
    },
    "LEADS_TO": {
      "è¯´æ˜": "çŒæ³¨ç­–ç•¥ -> çŒæ³¨ç»“æœ",
      "properties": {
        "æˆåŠŸç‡": "float",
        "æ–‡çŒ®è¯æ®": "string"
      }
    }
  },

  "æ–°å¢èŠ‚ç‚¹ç±»å‹ï¼ˆInstance Layerï¼‰": {
    "PerfusionCase": {
      "properties": {
        "case_id": "string",
        "heart_source": "enum[DBD, DCD]",
        "donor_age": "float",
        "ischemic_time_cold": "float",

        // æ—¶åºç‰¹å¾ï¼ˆå¤šæ—¶é—´ç‚¹ï¼‰
        "blood_gas_timeline": {
          "timestamps": "array<int>",     // [0, 5, 10, 15, ...] åˆ†é’Ÿ
          "pH": "array<float>",
          "PO2": "array<float>",
          "PCO2": "array<float>",
          "lactate": "array<float>",
          "K_plus": "array<float>"
        },

        "inflammatory_timeline": {
          "timestamps": "array<int>",
          "IL_6": "array<float>",
          "IL_8": "array<float>",
          "TNF_alpha": "array<float>"
        },

        "perfusion_params_timeline": {
          "timestamps": "array<int>",
          "pressure": "array<float>",
          "flow_rate": "array<float>",
          "temperature": "array<float>"
        },

        // çŒæ³¨ç»“æœ
        "outcome": {
          "quality_score": "float",
          "usable": "boolean",
          "contractility": "string",
          "rhythm": "string"
        }
      }
    },

    "HeartInstance": {
      "properties": {
        "heart_id": "string",
        "donor_type": "enum[DBD, DCD]",

        // å¿ƒè„æ–‡å­—æè¿° â†’ æ•°å€¼ç‰¹å¾æå–
        "anatomical_features": {
          "aortic_diameter": "float",      // "ä¸»åŠ¨è„‰å®½åº¦3.2cm" â†’ 3.2
          "left_ventricle_thickness": "float",
          "valve_condition": "string",
          "coronary_anatomy": "string"
        },

        // æå–çš„æ•°å€¼ç‰¹å¾å‘é‡ï¼ˆç”¨äºGNNï¼‰
        "feature_vector": "array<float, 30>"
      }
    }
  }
}
```

**çŸ¥è¯†å›¾è°±æ„å»ºæµç¨‹è°ƒæ•´**:

| æ­¥éª¤ | åŸæµç¨‹ï¼ˆå¿ƒè„ç§»æ¤ï¼‰ | æ–°æµç¨‹ï¼ˆå¿ƒè„çŒæ³¨ï¼‰ | æ˜¯å¦éœ€è¦æ”¹ |
|-----|-----------------|-----------------|----------|
| 1. æ–‡çŒ®çˆ¬å– | PubMedå¿ƒè„ç§»æ¤æ–‡çŒ® | **PubMedçŒæ³¨æ–‡çŒ® + æ“ä½œæ‰‹å†Œ** | âœ… æ‰©å±• |
| 2. Schemaè®¾è®¡ | ç§»æ¤ç›¸å…³å®ä½“/å…³ç³» | **çŒæ³¨ç­–ç•¥ã€ç›‘æµ‹æŒ‡æ ‡ã€ä»‹å…¥æªæ–½** | âœ… æ‰©å±• |
| 3. LLMæŠ½å– | ç§»æ¤çŸ¥è¯†ä¸‰å…ƒç»„ | **çŒæ³¨ç­–ç•¥ä¸‰å…ƒç»„ + æ—¶åºå…³ç³»** | âœ… æ‰©å±•Prompt |
| 4. æ•°å€¼ç‰¹å¾æå– | ä¾›ä½“/å—ä½“é™æ€ç‰¹å¾ | **æ—¶åºè¡€æ°”/ç‚ç—‡å› å­ + å¿ƒè„æè¿°â†’æ•°å€¼** | âœ… æ‰©å±• |
| 5. å›¾æ„å»º | Neo4jåŒå±‚å›¾ | **Neo4jåŒå±‚å›¾ï¼ˆæ–°å¢æ—¶åºè¾¹ï¼‰** | âœ… æ‰©å±• |
| 6. å›¾å¢å¼º | å®ä½“é“¾æ¥ã€å…³ç³»æ¨ç† | **ç›¸åŒï¼ˆæ–¹æ³•ä¸å˜ï¼‰** | âŒ ä¸å˜ |

**å…·ä½“è°ƒæ•´**:

```python
# æ‰©å±•LLMæŠ½å–Prompt
perfusion_extraction_prompt = f"""
è¯·ä»ä»¥ä¸‹**å¿ƒè„çŒæ³¨ç›¸å…³æ–‡çŒ®/æ“ä½œæ‰‹å†Œ**ä¸­æŠ½å–çŸ¥è¯†ä¸‰å…ƒç»„ã€‚

**å®ä½“ç±»å‹**:
  åŸæœ‰: {ç§»æ¤å®ä½“ç±»å‹}
  æ–°å¢: çŒæ³¨ç­–ç•¥, çŒæ³¨ç›‘æµ‹æŒ‡æ ‡, ä»‹å…¥æªæ–½, çŒæ³¨ç»“æœ

**å…³ç³»ç±»å‹**:
  åŸæœ‰: {ç§»æ¤å…³ç³»ç±»å‹}
  æ–°å¢: APPLIES_STRATEGY, MONITORS, TRIGGERS_INTERVENTION, LEADS_TO

**ç‰¹åˆ«å…³æ³¨**:
1. æ—¶åºå…³ç³»: "çŒæ³¨å¼€å§‹å10åˆ†é’ŸpHä¸‹é™è‡³7.1" â†’
   (æ—¶é—´ç‚¹:10åˆ†é’Ÿ) -MONITORS-> (pH, å€¼=7.1, å¼‚å¸¸=True)

2. å› æœé“¾: "ä½pHè§¦å‘è¡¥å……ç¢³é…¸æ°¢é’ ï¼Œ15åˆ†é’ŸåpHæ¢å¤è‡³7.35" â†’
   (pH<7.2) -TRIGGERS-> (è¡¥å……ç¢³é…¸æ°¢é’ ) -LEADS_TO-> (pH=7.35)

3. ç­–ç•¥-ç»“æœ: "HTKæ¶²é¡ºè¡ŒçŒæ³¨ï¼ŒçŒæ³¨åå¿ƒè„æ”¶ç¼©åŠ›è‰¯å¥½" â†’
   (HTKé¡ºè¡ŒçŒæ³¨) -LEADS_TO-> (æ”¶ç¼©åŠ›=è‰¯å¥½)

è¾“å‡ºJSONæ ¼å¼...
"""
```

---

#### ğŸ”§ æ‰©å±•3: **å®æ—¶é¢„æµ‹ä¸ä»‹å…¥æ¨èæ¨¡å—** (NEW Application Layer)

**ä¸ºä»€ä¹ˆéœ€è¦**: ç§»æ¤é¢„æµ‹æ˜¯ç¦»çº¿çš„ï¼ˆæœ¯å‰åšä¸€æ¬¡å†³ç­–ï¼‰ï¼ŒçŒæ³¨é¢„æµ‹éœ€è¦**åœ¨çº¿å®æ—¶æ¨ç†**

**ç³»ç»Ÿæµç¨‹**:

```
[çŒæ³¨å¼€å§‹] â†’ [å®æ—¶æ•°æ®é‡‡é›†] â†’ [å›¾æ›´æ–°] â†’ [GNNæ¨ç†] â†’ [é£é™©é¢„è­¦] â†’ [ä»‹å…¥æ¨è]
    â†“              â†“                â†“            â†“             â†“
  t=0min       t=5minè¡€æ°”      æ·»åŠ æ—¶åºèŠ‚ç‚¹   é¢„æµ‹ä¸‹ä¸€æ—¶åˆ»   æ˜¯å¦éœ€è¦å¹²é¢„ï¼Ÿ
```

**æŠ€æœ¯å®ç°**:

```python
class RealTimePerfusionMonitor:
    """å®æ—¶çŒæ³¨ç›‘æ§ä¸ä»‹å…¥æ¨è"""

    def __init__(self, kg_client, gnn_model, llm_agent):
        self.kg = kg_client  # Neo4jè¿æ¥
        self.gnn = gnn_model  # TemporalPerfusionGNN
        self.llm = llm_agent  # Medical Expert Agent

        self.alert_thresholds = {
            "pH": (7.35, 7.45),
            "lactate": (0.5, 2.0),
            "K_plus": (3.5, 5.0)
        }

    def monitor_perfusion(self, case_id: str, new_measurements: dict):
        """
        å®æ—¶ç›‘æ§çŒæ³¨è¿‡ç¨‹

        new_measurements: {
            "timestamp": 10,  # çŒæ³¨å¼€å§‹å10åˆ†é’Ÿ
            "pH": 7.15,       # âš ï¸ ä½äºæ­£å¸¸èŒƒå›´
            "PO2": 380,
            "lactate": 2.8,   # âš ï¸ é«˜äºæ­£å¸¸èŒƒå›´
            "IL_6": 45
        }
        """
        # 1. æ›´æ–°çŸ¥è¯†å›¾è°±ï¼ˆæ·»åŠ æ–°æ—¶é—´ç‚¹çš„ç›‘æµ‹èŠ‚ç‚¹ï¼‰
        self.kg.add_temporal_measurement(case_id, new_measurements)

        # 2. æå–å­å›¾ï¼ˆå½“å‰çŒæ³¨æ¡ˆä¾‹ + å†å²æ—¶åºæ•°æ®ï¼‰
        subgraph = self.kg.get_perfusion_subgraph(case_id)

        # 3. GNNé¢„æµ‹ä¸‹ä¸€æ—¶åˆ»çŠ¶æ€
        prediction = self.gnn.predict_next_state(subgraph)
        # prediction = {
        #     "next_pH": 7.12,        # é¢„æµ‹ç»§ç»­ä¸‹é™
        #     "next_lactate": 3.1,     # é¢„æµ‹ç»§ç»­å‡é«˜
        #     "risk_score": 0.78,      # é«˜é£é™©
        #     "need_intervention": True
        # }

        # 4. é£é™©è¯„ä¼°
        alerts = []
        if new_measurements["pH"] < self.alert_thresholds["pH"][0]:
            alerts.append({
                "type": "é…¸ä¸­æ¯’",
                "severity": "é«˜",
                "indicator": f"pH={new_measurements['pH']} (æ­£å¸¸ 7.35-7.45)",
                "predicted_trend": "ç»§ç»­ä¸‹é™" if prediction["next_pH"] < new_measurements["pH"] else "ç¨³å®š"
            })

        if new_measurements["lactate"] > self.alert_thresholds["lactate"][1]:
            alerts.append({
                "type": "ä»£è°¢å¼‚å¸¸",
                "severity": "ä¸­",
                "indicator": f"ä¹³é…¸={new_measurements['lactate']} (æ­£å¸¸ 0.5-2.0)",
                "predicted_trend": "ç»§ç»­å‡é«˜"
            })

        # 5. å¦‚æœæœ‰é£é™©ï¼Œæ¨èä»‹å…¥æªæ–½
        if prediction["need_intervention"]:
            interventions = self.recommend_interventions(alerts, subgraph)
            return {
                "status": "éœ€è¦ä»‹å…¥",
                "alerts": alerts,
                "recommendations": interventions
            }
        else:
            return {
                "status": "æ­£å¸¸",
                "prediction": prediction
            }

    def recommend_interventions(self, alerts, subgraph):
        """
        ç»“åˆGNN + LLMæ¨èä»‹å…¥æªæ–½
        """
        # 1. GNNæ£€ç´¢ï¼šä»çŸ¥è¯†å›¾è°±ä¸­æ‰¾åˆ°ç›¸ä¼¼æ¡ˆä¾‹çš„æˆåŠŸä»‹å…¥æªæ–½
        similar_cases = self.kg.query(f"""
            MATCH (pc:PerfusionCase)-[:MONITORS]->(m:çŒæ³¨ç›‘æµ‹æŒ‡æ ‡)
            WHERE m.pH BETWEEN {alerts[0]['pH'] - 0.1} AND {alerts[0]['pH'] + 0.1}
            AND pc.outcome.usable = true
            MATCH (pc)-[:APPLIES_INTERVENTION]->(i:ä»‹å…¥æªæ–½)
            RETURN i.æªæ–½ç±»å‹, i.å…·ä½“æ“ä½œ, i.é¢„æœŸæ•ˆæœ, count(*) as æˆåŠŸæ¬¡æ•°
            ORDER BY æˆåŠŸæ¬¡æ•° DESC
            LIMIT 5
        """)

        # 2. LLMæ¨ç†ï¼šæ ¹æ®å½“å‰å…·ä½“æƒ…å†µç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®
        llm_recommendation = self.llm.reason(
            context=f"å½“å‰çŒæ³¨æ¡ˆä¾‹ï¼š{subgraph.to_dict()}",
            alerts=alerts,
            knowledge_base=similar_cases
        )

        return {
            "knowledge_based": similar_cases,  # åŸºäºå†å²æ¡ˆä¾‹çš„æ¨è
            "llm_reasoning": llm_recommendation  # LLMä¸ªæ€§åŒ–æ¨ç†
        }
```

**ä¸ç°æœ‰Analyzer Agentçš„é›†æˆ**:

```
åŸAnalyzer Agent (ç§»æ¤é¢„æµ‹):
  Input: é™æ€ä¾›ä½“/å—ä½“ç‰¹å¾
  Output: ç§»æ¤æˆåŠŸç‡ã€PGDé£é™©

æ‰©å±•åAnalyzer Agent (çŒæ³¨é¢„æµ‹):
  Input:
    - é™æ€: å¿ƒè„ç‰¹å¾ï¼ˆä¸»åŠ¨è„‰å®½åº¦ç­‰ï¼‰
    - åŠ¨æ€: æ—¶åºç›‘æµ‹æ•°æ®ï¼ˆè¡€æ°”ã€ç‚ç—‡å› å­ï¼‰
    - ç­–ç•¥: æ‹ŸçŒæ³¨ç­–ç•¥

  Output:
    - çŒæ³¨è´¨é‡é¢„æµ‹
    - é£é™©é¢„è­¦
    - ä»‹å…¥æªæ–½æ¨è

  æ–°å¢æ–¹æ³•:
    - analyze_perfusion_strategy(strategy, heart_features)
    - monitor_real_time(case_id, measurements)
    - recommend_intervention(alerts)
```

---

## 2. é’ˆå¯¹æ–°æ•°æ®ç±»å‹çš„å¤„ç†ç­–ç•¥

### 2.1 æ‹ŸçŒæ³¨ç­–ç•¥ï¼ˆå¯¹æ ‡æ‰‹æœ¯planï¼‰

**æ•°æ®ç¤ºä¾‹**:
```json
{
  "perfusion_plan": {
    "donor_type": "DCD",
    "perfusion_method": "é¡ºè¡ŒçŒæ³¨",
    "perfusion_solution": "HTKæ¶²",
    "target_temperature": "4Â°C",
    "target_pressure": "50-70 mmHg",
    "target_flow": "1.5 L/min",
    "expected_duration": "60åˆ†é’Ÿ",
    "monitoring_protocol": "æ¯5åˆ†é’Ÿè¡€æ°”åˆ†æ"
  }
}
```

**å¤„ç†æ–¹æ³•**:
1. **è¡¨ç¤ºä¸ºå›¾èŠ‚ç‚¹**: `PerfusionPlan` èŠ‚ç‚¹ï¼ŒåŒ…å«ç­–ç•¥å‚æ•°
2. **ä¸çŸ¥è¯†å›¾è°±é“¾æ¥**:
   ```cypher
   MATCH (plan:PerfusionPlan {solution: "HTKæ¶²"})
   MATCH (concept:ConceptNode {name: "HTKæ¶²", type: "çŒæ³¨æ¶²"})
   CREATE (plan)-[:USES_SOLUTION]->(concept)
   ```
3. **RAGæ£€ç´¢**: ç»™å®šæ–°çš„çŒæ³¨ç­–ç•¥ï¼Œæ£€ç´¢å†å²ç›¸ä¼¼ç­–ç•¥çš„ç»“æœ
   ```python
   similar_plans = kg.query("""
       MATCH (p:PerfusionPlan)
       WHERE p.solution = $solution
         AND p.donor_type = $donor_type
         AND abs(p.target_pressure - $target_pressure) < 10
       MATCH (p)-[:LEADS_TO]->(r:çŒæ³¨ç»“æœ)
       RETURN p, r, r.quality_score
       ORDER BY r.quality_score DESC
       LIMIT 10
   """)
   ```

---

### 2.2 å¼‚æ„çŒæ³¨æ•°æ®

#### A. **è¡€æ°”æ•°æ®**ï¼ˆæ—¶åºï¼‰

**åŸå§‹æ•°æ®æ ¼å¼**:
```json
{
  "blood_gas": [
    {"time": 0, "pH": 7.40, "PO2": 450, "PCO2": 35, "HCO3": 24, "lactate": 1.2},
    {"time": 5, "pH": 7.35, "PO2": 420, "PCO2": 38, "HCO3": 22, "lactate": 1.5},
    {"time": 10, "pH": 7.28, "PO2": 380, "PCO2": 42, "HCO3": 20, "lactate": 2.3},
    ...
  ]
}
```

**å¤„ç†ç­–ç•¥**:

1. **ä½œä¸ºèŠ‚ç‚¹å±æ€§ï¼ˆæ•°ç»„å½¢å¼ï¼‰**:
   ```python
   perfusion_case = {
       "case_id": "PERF_20260109_001",
       "blood_gas_timeline": {
           "timestamps": [0, 5, 10, 15, 20, ...],
           "pH": [7.40, 7.35, 7.28, ...],
           "PO2": [450, 420, 380, ...],
           "lactate": [1.2, 1.5, 2.3, ...]
       }
   }
   ```

2. **ä¹Ÿå¯å»ºæ¨¡ä¸ºæ—¶åºè¾¹**ï¼ˆç”¨äºå›¾ç¥ç»ç½‘ç»œæ•æ‰æ—¶é—´ä¾èµ–ï¼‰:
   ```cypher
   CREATE (case:PerfusionCase {id: "PERF_001"})
   CREATE (m1:Measurement {time: 0, pH: 7.40, lactate: 1.2})
   CREATE (m2:Measurement {time: 5, pH: 7.35, lactate: 1.5})
   CREATE (case)-[:MEASURED_AT {time: 0}]->(m1)
   CREATE (case)-[:MEASURED_AT {time: 5}]->(m2)
   CREATE (m1)-[:NEXT_MEASUREMENT]->(m2)  # æ—¶åºè¾¹
   ```

3. **ç‰¹å¾å·¥ç¨‹**:
   ```python
   def extract_temporal_features(blood_gas_timeline):
       """ä»æ—¶åºè¡€æ°”æ•°æ®ä¸­æå–ç‰¹å¾"""
       return {
           # è¶‹åŠ¿ç‰¹å¾
           "pH_trend": np.polyfit(timeline.timestamps, timeline.pH, deg=1)[0],  # æ–œç‡
           "lactate_increase_rate": (timeline.lactate[-1] - timeline.lactate[0]) / len(timeline.lactate),

           # å¼‚å¸¸æ£€æµ‹
           "pH_below_threshold_count": sum(ph < 7.35 for ph in timeline.pH),
           "max_lactate": max(timeline.lactate),

           # ç¨³å®šæ€§
           "pH_std": np.std(timeline.pH),
           "PO2_variability": np.std(timeline.PO2) / np.mean(timeline.PO2)
       }
   ```

---

#### B. **æ ‡ç­¾åŒ–çš„çŒæ³¨ç»“æœ**

**åŸå§‹æ•°æ®æ ¼å¼**:
```json
{
  "perfusion_outcome": {
    "quality_score": 85,  # 0-100
    "usable_for_transplant": true,
    "contractility": "è‰¯å¥½",
    "rhythm": "çª¦æ€§å¿ƒå¾‹",
    "coronary_flow": "é€šç•…",
    "complications": ["è½»åº¦å¿ƒè‚Œæ°´è‚¿"]
  }
}
```

**å¤„ç†ç­–ç•¥**:
1. **ä½œä¸ºç›‘ç£ä¿¡å·**: è®­ç»ƒGNNçš„ç›®æ ‡å˜é‡
   ```python
   # è®­ç»ƒæ•°æ®
   X = [blood_gas_features, perfusion_params, heart_features]
   y = perfusion_outcome.quality_score  # å›å½’ä»»åŠ¡

   # æˆ–å¤šåˆ†ç±»ä»»åŠ¡
   y_class = {
       "ä¼˜ç§€": quality_score >= 90,
       "è‰¯å¥½": 75 <= quality_score < 90,
       "ä¸€èˆ¬": 60 <= quality_score < 75,
       "å·®": quality_score < 60
   }
   ```

2. **å…³è”åˆ°çŒæ³¨ç­–ç•¥èŠ‚ç‚¹**:
   ```cypher
   MATCH (plan:PerfusionPlan {id: "PLAN_001"})
   MATCH (case:PerfusionCase {id: "PERF_001"})
   WHERE case.outcome.quality_score > 80
   CREATE (plan)-[:ACHIEVED_OUTCOME {score: case.outcome.quality_score}]->(case)
   ```

---

#### C. **ç‚ç—‡å› å­æ•°æ®**ï¼ˆæ—¶åºï¼‰

**å¤„ç†æ–¹æ³•**: åŒè¡€æ°”æ•°æ®ï¼Œä½œä¸ºé¢å¤–çš„æ—¶åºç‰¹å¾

```python
inflammatory_features = {
    "IL_6_timeline": [20, 35, 48, 52, ...],  # pg/mL
    "IL_8_timeline": [15, 28, 42, 50, ...],
    "TNF_alpha_timeline": [5, 12, 18, 22, ...]
}

# ä¸è¡€æ°”æ•°æ®è”åˆåˆ†æ
combined_features = np.concatenate([
    blood_gas_features,      # shape: (time_steps, 5)
    inflammatory_features,   # shape: (time_steps, 3)
    perfusion_params        # shape: (time_steps, 4)
], axis=-1)  # â†’ (time_steps, 12)
```

---

#### D. **æ—¶åºçš„çŒæ³¨ä¸­æ•°æ®**ï¼ˆå‹åŠ›ã€æµé‡ã€æ¸©åº¦ï¼‰

**å¤„ç†æ–¹æ³•**:
1. **ä½œä¸ºå¯æ§å˜é‡**: ä¸è¡€æ°”/ç‚ç—‡å› å­ä¸åŒï¼Œè¿™äº›æ˜¯**å¯ä»¥è°ƒæ•´çš„å‚æ•°**
2. **å»ºæ¨¡ä¸ºåŠ¨ä½œç©ºé—´**:
   ```python
   class PerfusionAction:
       """çŒæ³¨ä¸­çš„å¯è°ƒå‚æ•°"""
       pressure_adjustment: float  # Â±10 mmHg
       flow_adjustment: float      # Â±0.2 L/min
       temperature_adjustment: float  # Â±2Â°C
       add_supplement: str         # "NaHCO3", "KCl", None
   ```

3. **å¼ºåŒ–å­¦ä¹ é›†æˆ** (å¯é€‰é«˜çº§åŠŸèƒ½):
   ```python
   # å°†çŒæ³¨è¿‡ç¨‹å»ºæ¨¡ä¸ºMDP (Markov Decision Process)
   state = [blood_gas, inflammatory, current_perfusion_params]
   action = [adjust_pressure, adjust_flow, add_supplement]
   reward = perfusion_quality_improvement

   # ä½¿ç”¨RLè®­ç»ƒæœ€ä¼˜ä»‹å…¥ç­–ç•¥
   agent = PPO(state_dim, action_dim)
   agent.train(perfusion_cases)
   ```

---

### 2.3 å¿ƒè„æ–‡å­—æè¿°ï¼ˆå¦‚ä¸»åŠ¨è„‰å®½åº¦ï¼‰

**åŸå§‹æ•°æ®ç¤ºä¾‹**:
```text
"ä¾›å¿ƒè¯„ä¼°æŠ¥å‘Šï¼š
- ä¸»åŠ¨è„‰æ ¹éƒ¨ç›´å¾„3.2cmï¼Œæœªè§æ˜æ˜¾ç‹­çª„
- å·¦å¿ƒå®¤å£åšåº¦1.1cmï¼Œæ”¶ç¼©åŠŸèƒ½è‰¯å¥½
- äºŒå°–ç“£è½»åº¦åæµï¼Œä¸»åŠ¨è„‰ç“£åŠŸèƒ½æ­£å¸¸
- å† çŠ¶åŠ¨è„‰å·¦å‰é™æ”¯è¿‘ç«¯é’™åŒ–æ–‘å—ï¼Œæ— æ˜æ˜¾ç‹­çª„"
```

**å¤„ç†ç­–ç•¥**:

#### æ–¹æ³•1: **æ•°å€¼ç‰¹å¾æå–**ï¼ˆæ‰©å±•`numerical_feature_extractor.py`ï¼‰

```python
class HeartAnatomyExtractor:
    """ä»æ–‡å­—æè¿°ä¸­æå–å¿ƒè„è§£å‰–æ•°å€¼ç‰¹å¾"""

    patterns = {
        "aortic_diameter": [
            r"ä¸»åŠ¨è„‰(?:æ ¹éƒ¨)?ç›´å¾„.*?(\d+\.?\d*)\s*cm",
            r"aortic\s+diameter.*?(\d+\.?\d*)\s*cm"
        ],
        "lv_wall_thickness": [
            r"å·¦å¿ƒå®¤å£åšåº¦.*?(\d+\.?\d*)\s*cm",
            r"LV\s+wall\s+thickness.*?(\d+\.?\d*)\s*cm"
        ],
        "ejection_fraction": [
            r"å°„è¡€åˆ†æ•°.*?(\d+\.?\d*)%",
            r"LVEF.*?(\d+\.?\d*)%",
            r"EF.*?(\d+\.?\d*)%"
        ],
        # ... æ›´å¤šè§£å‰–ç‰¹å¾
    }

    def extract(self, text: str) -> dict:
        features = {}
        for feature_name, patterns in self.patterns.items():
            for pattern in patterns:
                match = re.search(pattern, text, re.IGNORECASE)
                if match:
                    features[feature_name] = float(match.group(1))
                    break
        return features

# ä½¿ç”¨ç¤ºä¾‹
extractor = HeartAnatomyExtractor()
heart_features = extractor.extract(report_text)
# â†’ {"aortic_diameter": 3.2, "lv_wall_thickness": 1.1, "ejection_fraction": 55}
```

#### æ–¹æ³•2: **LLMç»“æ„åŒ–æŠ½å–**ï¼ˆç”¨äºå¤æ‚æè¿°ï¼‰

```python
def extract_heart_anatomy_llm(text: str) -> dict:
    """ä½¿ç”¨LLMä»éç»“æ„åŒ–æ–‡æœ¬ä¸­æŠ½å–å¿ƒè„ç‰¹å¾"""

    prompt = f"""
    ä»ä»¥ä¸‹å¿ƒè„è¯„ä¼°æŠ¥å‘Šä¸­æŠ½å–ç»“æ„åŒ–ç‰¹å¾ï¼š

    {text}

    è¾“å‡ºJSONæ ¼å¼ï¼š
    {{
      "numerical_features": {{
        "aortic_diameter_cm": <float or null>,
        "lv_wall_thickness_cm": <float or null>,
        "ejection_fraction_percent": <float or null>
      }},
      "categorical_features": {{
        "valve_condition": "æ­£å¸¸/è½»åº¦åæµ/ä¸­åº¦åæµ/é‡åº¦åæµ",
        "coronary_anatomy": "æ­£å¸¸/é’™åŒ–æ–‘å—/ç‹­çª„",
        "contractility": "ä¼˜ç§€/è‰¯å¥½/ä¸€èˆ¬/å·®"
      }},
      "risk_factors": [<list of identified risks>]
    }}
    """

    response = llm.call(prompt)
    return json.loads(response)
```

#### æ–¹æ³•3: **æ··åˆç­–ç•¥**ï¼ˆæ¨èï¼‰

```python
def extract_heart_features(text: str) -> dict:
    """æ··åˆä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’ŒLLM"""

    # 1. å…ˆç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æ˜ç¡®çš„æ•°å€¼
    regex_features = HeartAnatomyExtractor().extract(text)

    # 2. ç”¨LLMæå–å¤æ‚çš„å®šæ€§ç‰¹å¾å’Œé£é™©å› ç´ 
    llm_features = extract_heart_anatomy_llm(text)

    # 3. åˆå¹¶ç‰¹å¾
    combined = {
        **regex_features,
        **llm_features["categorical_features"],
        "risk_factors": llm_features["risk_factors"]
    }

    return combined
```

**é›†æˆåˆ°å›¾ç»“æ„**:

```python
# åˆ›å»ºHeartInstanceèŠ‚ç‚¹
heart_node = {
    "heart_id": "HEART_001",
    "donor_type": "DCD",

    # æ•°å€¼ç‰¹å¾ï¼ˆç”¨äºGNNï¼‰
    "aortic_diameter": 3.2,
    "lv_wall_thickness": 1.1,
    "ejection_fraction": 55,

    # å®šæ€§ç‰¹å¾ï¼ˆç”¨äºLLMæ¨ç†ï¼‰
    "valve_condition": "è½»åº¦åæµ",
    "coronary_anatomy": "é’™åŒ–æ–‘å—",

    # åŸå§‹æ–‡æœ¬ï¼ˆä¿ç•™ç”¨äºLLM RAGæ£€ç´¢ï¼‰
    "raw_description": original_text,

    # ç‰¹å¾å‘é‡ï¼ˆå½’ä¸€åŒ–åç”¨äºGNNè¾“å…¥ï¼‰
    "feature_vector": [
        normalize(3.2, min=2.0, max=4.0),  # aortic_diameter
        normalize(1.1, min=0.6, max=1.5),  # lv_wall_thickness
        normalize(55, min=30, max=70),     # ejection_fraction
        # ... å…¶ä»–ç‰¹å¾
    ]
}
```

---

## 3. æ ¸å¿ƒé—®é¢˜å›ç­”ï¼šæ˜¯å¦èƒ½åšåˆ°é¢„æµ‹å’Œä»‹å…¥æ¨èï¼Ÿ

### âœ… **å®Œå…¨å¯ä»¥åšåˆ°ï¼Œè€Œä¸”æ¶æ„æ›´å¼ºå¤§**

#### 3.1 çŒæ³¨ç»“æœé¢„æµ‹

**è¾“å…¥**:
- æ‹ŸçŒæ³¨ç­–ç•¥ï¼ˆçŒæ³¨æ¶²ã€å‹åŠ›ã€æµé‡ã€æ¸©åº¦ï¼‰
- å¿ƒè„ç‰¹å¾ï¼ˆä¸»åŠ¨è„‰å®½åº¦ç­‰æ•°å€¼ + æ–‡å­—æè¿°ï¼‰
- ï¼ˆå¯é€‰ï¼‰ä¾›ä½“ç‰¹å¾ï¼ˆå¹´é¾„ã€ç¼ºè¡€æ—¶é—´ï¼‰

**æ¨¡å‹**:
```python
class PerfusionOutcomePredictor:
    def predict(self, plan, heart, donor=None):
        # 1. RAGæ£€ç´¢ï¼šæ‰¾åˆ°ç›¸ä¼¼å†å²æ¡ˆä¾‹
        similar_cases = self.kg.query(f"""
            MATCH (h:HeartInstance)
            WHERE abs(h.aortic_diameter - {heart.aortic_diameter}) < 0.3
              AND h.valve_condition = '{heart.valve_condition}'
            MATCH (h)<-[:PERFUSED]-(pc:PerfusionCase)
            MATCH (pc)-[:APPLIES]->(p:PerfusionPlan)
            WHERE p.solution = '{plan.solution}'
              AND abs(p.target_pressure - {plan.target_pressure}) < 10
            RETURN pc.outcome.quality_score, pc.outcome.usable
            ORDER BY pc.timestamp DESC
            LIMIT 20
        """)

        # 2. GNNé¢„æµ‹
        graph = self.build_prediction_graph(plan, heart, donor)
        gnn_prediction = self.gnn(graph)

        # 3. LLMæ¨ç†
        llm_analysis = self.llm.reason(
            f"""åŸºäºä»¥ä¸‹ä¿¡æ¯é¢„æµ‹çŒæ³¨ç»“æœï¼š

            çŒæ³¨ç­–ç•¥ï¼š{plan}
            å¿ƒè„ç‰¹å¾ï¼š{heart}
            ç›¸ä¼¼å†å²æ¡ˆä¾‹ï¼š{similar_cases}
            GNNé¢„æµ‹ï¼š{gnn_prediction}

            è¯·åˆ†æï¼š
            1. é¢„æœŸçŒæ³¨è´¨é‡è¯„åˆ†ï¼ˆ0-100ï¼‰
            2. å¯èƒ½çš„é£é™©ç‚¹
            3. æ˜¯å¦é€‚åˆè¯¥çŒæ³¨ç­–ç•¥
            """
        )

        return {
            "predicted_quality_score": gnn_prediction.score,
            "confidence": gnn_prediction.confidence,
            "historical_success_rate": sum(c.usable for c in similar_cases) / len(similar_cases),
            "llm_analysis": llm_analysis,
            "recommendation": "é€‚åˆ" if gnn_prediction.score > 75 else "éœ€è¦è°ƒæ•´ç­–ç•¥"
        }
```

**è¾“å‡ºç¤ºä¾‹**:
```json
{
  "predicted_quality_score": 82.5,
  "confidence": 0.87,
  "historical_success_rate": 0.85,
  "llm_analysis": {
    "summary": "è¯¥å¿ƒè„ä¸»åŠ¨è„‰å®½åº¦æ­£å¸¸ï¼Œä½¿ç”¨HTKæ¶²é¡ºè¡ŒçŒæ³¨æˆåŠŸç‡é«˜",
    "risk_factors": ["è½»åº¦ç“£è†œåæµå¯èƒ½å½±å“çŒæ³¨å‡åŒ€æ€§"],
    "suggestions": ["å»ºè®®åŠ å¼ºå† è„‰çŒæ³¨ç›‘æµ‹"]
  },
  "recommendation": "é€‚åˆ"
}
```

---

#### 3.2 çŒæ³¨ä¸­é—®é¢˜é¢„è­¦

**å®æ—¶ç›‘æ§æµç¨‹**:

```python
# æ¨¡æ‹ŸçŒæ³¨ä¸­çš„å®æ—¶æ•°æ®æµ
perfusion_monitor = RealTimePerfusionMonitor(kg, gnn, llm)

# t=0: çŒæ³¨å¼€å§‹
perfusion_monitor.start_case("PERF_20260109_001", plan, heart)

# t=5min: ç¬¬ä¸€æ¬¡è¡€æ°”åˆ†æ
measurement_5min = {
    "time": 5,
    "pH": 7.38,
    "PO2": 420,
    "lactate": 1.3,
    "IL_6": 22
}
status = perfusion_monitor.monitor(measurement_5min)
# â†’ {"status": "æ­£å¸¸", "predicted_next": {...}}

# t=10min: ç¬¬äºŒæ¬¡è¡€æ°”åˆ†æ - å‡ºç°å¼‚å¸¸
measurement_10min = {
    "time": 10,
    "pH": 7.26,  # âš ï¸ é…¸ä¸­æ¯’
    "PO2": 380,
    "lactate": 2.5,  # âš ï¸ ä¹³é…¸å‡é«˜
    "IL_6": 48
}
status = perfusion_monitor.monitor(measurement_10min)
# â†’ {
#   "status": "éœ€è¦ä»‹å…¥",
#   "alerts": [
#     {"type": "é…¸ä¸­æ¯’", "severity": "é«˜", "indicator": "pH=7.26"},
#     {"type": "ä»£è°¢å¼‚å¸¸", "severity": "ä¸­", "indicator": "ä¹³é…¸=2.5"}
#   ],
#   "recommendations": [...]
# }
```

---

#### 3.3 ä»‹å…¥æªæ–½æ¨è

**æ¨èç­–ç•¥**:

```python
def recommend_intervention(alerts, current_state, perfusion_graph):
    """ç»“åˆçŸ¥è¯†å›¾è°±å’Œæœºå™¨å­¦ä¹ æ¨èä»‹å…¥æªæ–½"""

    # 1. ä»KGæ£€ç´¢ï¼šå†å²ç›¸ä¼¼æƒ…å†µçš„æˆåŠŸä»‹å…¥
    kg_recommendations = kg.query(f"""
        MATCH (alert:Alert {{type: '{alerts[0].type}'}})
        MATCH (alert)-[:TRIGGERED]->(intervention:ä»‹å…¥æªæ–½)
        MATCH (intervention)-[:RESOLVED]->(case:PerfusionCase)
        WHERE case.outcome.usable = true
        RETURN intervention,
               count(case) as success_count,
               avg(case.outcome.quality_score) as avg_quality
        ORDER BY success_count DESC
        LIMIT 5
    """)
    # â†’ [
    #   {"intervention": "è¡¥å……NaHCO3 50mEq", "success_count": 35, "avg_quality": 82},
    #   {"intervention": "é™ä½çŒæ³¨å‹è‡³40mmHg", "success_count": 28, "avg_quality": 78},
    #   ...
    # ]

    # 2. GNNé¢„æµ‹ï¼šæ¯ç§ä»‹å…¥æªæ–½çš„é¢„æœŸæ•ˆæœ
    intervention_effects = []
    for intervention in kg_recommendations:
        # æ¨¡æ‹Ÿåº”ç”¨è¯¥ä»‹å…¥æªæ–½åçš„å›¾çŠ¶æ€
        simulated_graph = perfusion_graph.apply_intervention(intervention)
        predicted_outcome = gnn.predict(simulated_graph)
        intervention_effects.append({
            "intervention": intervention,
            "predicted_pH_change": predicted_outcome.next_pH - current_state.pH,
            "predicted_quality": predicted_outcome.quality_score
        })

    # 3. LLMç”Ÿæˆä¸ªæ€§åŒ–è§£é‡Š
    llm_recommendation = llm.reason(f"""
    å½“å‰çŠ¶æ€ï¼š{current_state}
    è­¦æŠ¥ï¼š{alerts}
    å†å²æˆåŠŸæ¡ˆä¾‹æ¨èï¼š{kg_recommendations}
    é¢„æµ‹æ•ˆæœï¼š{intervention_effects}

    è¯·æ¨èæœ€ä½³ä»‹å…¥æªæ–½ï¼Œå¹¶è§£é‡ŠåŸå› ã€‚
    """)

    return {
        "top_recommendation": intervention_effects[0],
        "alternatives": intervention_effects[1:3],
        "reasoning": llm_recommendation,
        "urgency": "é«˜" if alerts[0].severity == "é«˜" else "ä¸­"
    }
```

**è¾“å‡ºç¤ºä¾‹**:
```json
{
  "top_recommendation": {
    "intervention": "è¡¥å……NaHCO3 50mEq",
    "predicted_pH_change": +0.15,
    "predicted_quality": 80,
    "success_rate": 0.87,
    "expected_time_to_effect": "10-15åˆ†é’Ÿ"
  },
  "alternatives": [
    {
      "intervention": "é™ä½çŒæ³¨å‹è‡³40mmHg",
      "predicted_pH_change": +0.08,
      "predicted_quality": 75
    }
  ],
  "reasoning": {
    "summary": "å½“å‰pH 7.26ä¼´ä¹³é…¸å‡é«˜ï¼Œæç¤ºä»£è°¢æ€§é…¸ä¸­æ¯’ã€‚è¡¥å……ç¢³é…¸æ°¢é’ å¯å¿«é€Ÿçº æ­£pHï¼Œå†å²35ä¾‹ç›¸ä¼¼æƒ…å†µä¸­30ä¾‹æˆåŠŸã€‚",
    "risk_assessment": "è¯¥å¿ƒè„ä¸»åŠ¨è„‰å®½åº¦æ­£å¸¸ï¼Œè€å—ç¢³é…¸æ°¢é’ è¡¥å……ï¼Œé£é™©ä½ã€‚",
    "monitoring_plan": "è¡¥å……å5åˆ†é’Ÿå¤æŸ¥è¡€æ°”ï¼Œé¢„æœŸpHå›å‡è‡³7.35ä»¥ä¸Šã€‚"
  },
  "urgency": "é«˜"
}
```

---

## 4. æ€»ç»“ï¼šæ¶æ„é€‚é…æ–¹æ¡ˆ

### âœ… ä¿æŒä¸å˜çš„æ ¸å¿ƒ
1. **Multi-Agentæ¡†æ¶** (LangGraph)
2. **åŒå±‚å›¾ç»“æ„** (Concept + Instance)
3. **Neuro-Symbolicæ¨ç†** (GNN + LLM)
4. **å››å±‚å¤„ç†æ¶æ„** (LLMæŠ½å– + æœ¬åœ°å¤„ç†)

### ğŸ”§ éœ€è¦æ‰©å±•çš„3ä¸ªæ¨¡å—
1. **æ—¶åºæ•°æ®å¤„ç†æ¨¡å—**:
   - æ–°å¢ `TemporalPerfusionGNN`ï¼ˆLSTM + GraphSAGEï¼‰
   - å¤„ç†è¡€æ°”ã€ç‚ç—‡å› å­ã€çŒæ³¨å‚æ•°çš„æ—¶åºæ•°æ®

2. **çŒæ³¨çŸ¥è¯†å›¾è°±æ¨¡å—**:
   - Schemaæ‰©å±•ï¼šçŒæ³¨ç­–ç•¥ã€ç›‘æµ‹æŒ‡æ ‡ã€ä»‹å…¥æªæ–½ã€çŒæ³¨ç»“æœ
   - æ–°å¢å®ä½“ç±»å‹ï¼šPerfusionCase, HeartInstance, çŒæ³¨ç›‘æµ‹æŒ‡æ ‡
   - æ–°å¢å…³ç³»ç±»å‹ï¼šAPPLIES_STRATEGY, MONITORS, TRIGGERS_INTERVENTION

3. **å®æ—¶é¢„æµ‹ä¸ä»‹å…¥æ¨èæ¨¡å—**:
   - `RealTimePerfusionMonitor`: å®æ—¶ç›‘æ§çŒæ³¨è¿‡ç¨‹
   - `recommend_intervention()`: ç»“åˆKG + GNN + LLMæ¨èä»‹å…¥æªæ–½
   - é£é™©é¢„è­¦ç³»ç»Ÿï¼ˆé˜ˆå€¼æ£€æµ‹ + è¶‹åŠ¿é¢„æµ‹ï¼‰

### ğŸ“Š æ•°æ®å¤„ç†ç­–ç•¥

| æ•°æ®ç±»å‹ | å¤„ç†æ–¹æ³• | å›¾è¡¨ç¤º | GNNç‰¹å¾ |
|---------|---------|--------|---------|
| **æ‹ŸçŒæ³¨ç­–ç•¥** | å‚æ•°åŒ–è¡¨ç¤º | PerfusionPlanèŠ‚ç‚¹ | ç­–ç•¥embedding |
| **è¡€æ°”æ•°æ®** | æ—¶åºç‰¹å¾æå– | MeasurementèŠ‚ç‚¹+æ—¶åºè¾¹ | LSTMç¼–ç  |
| **ç‚ç—‡å› å­** | æ—¶åºç‰¹å¾æå– | MeasurementèŠ‚ç‚¹+æ—¶åºè¾¹ | LSTMç¼–ç  |
| **çŒæ³¨å‚æ•°** | æ—¶åº+å¯æ§å˜é‡ | èŠ‚ç‚¹å±æ€§ | ç›´æ¥è¾“å…¥ |
| **çŒæ³¨ç»“æœ** | æ ‡ç­¾åŒ– | èŠ‚ç‚¹å±æ€§ | ç›‘ç£ä¿¡å· |
| **å¿ƒè„æè¿°** | æ•°å€¼æå–+æ–‡æœ¬ä¿ç•™ | HeartInstanceèŠ‚ç‚¹ | æ•°å€¼ç‰¹å¾å‘é‡ |

### âœ… æœ€ç»ˆå›ç­”

**é—®ï¼šæ˜¯å¦èƒ½åšåˆ°å¯¹çŒæ³¨ç»“æœçš„é¢„æµ‹ä»¥åŠçŒæ³¨ä¸­å¯èƒ½å‡ºç°çš„é—®é¢˜åŠä»‹å…¥æªæ–½ï¼Ÿ**

**ç­”ï¼šå®Œå…¨å¯ä»¥ï¼Œè€Œä¸”æ¯”åŸç§»æ¤é¢„æµ‹æ›´å¼ºå¤§**:

1. **çŒæ³¨ç»“æœé¢„æµ‹** âœ…
   - è¾“å…¥ï¼šæ‹ŸçŒæ³¨ç­–ç•¥ + å¿ƒè„ç‰¹å¾
   - æ–¹æ³•ï¼šRAGæ£€ç´¢å†å²æ¡ˆä¾‹ + GNNé¢„æµ‹ + LLMæ¨ç†
   - è¾“å‡ºï¼šè´¨é‡è¯„åˆ†ã€æˆåŠŸç‡ã€é£é™©è¯„ä¼°ã€ç­–ç•¥å»ºè®®

2. **çŒæ³¨ä¸­é—®é¢˜é¢„è­¦** âœ…
   - å®æ—¶ç›‘æ§ï¼šæ¯5åˆ†é’Ÿè¡€æ°”/ç‚ç—‡å› å­
   - æ—¶åºGNNï¼šé¢„æµ‹ä¸‹ä¸€æ—¶åˆ»è¶‹åŠ¿
   - é£é™©æ£€æµ‹ï¼šé˜ˆå€¼æ£€æµ‹ + å¼‚å¸¸æ¨¡å¼è¯†åˆ«

3. **ä»‹å…¥æªæ–½æ¨è** âœ…
   - KGæ£€ç´¢ï¼šå†å²æˆåŠŸä»‹å…¥æ¡ˆä¾‹
   - GNNæ¨¡æ‹Ÿï¼šé¢„æµ‹æ¯ç§ä»‹å…¥çš„æ•ˆæœ
   - LLMæ¨ç†ï¼šç”Ÿæˆä¸ªæ€§åŒ–è§£é‡Šå’Œç›‘æµ‹æ–¹æ¡ˆ

**æ¶æ„ä¼˜åŠ¿**:
- **æ›´çµæ´»**: æ—¶åºå›¾ç»“æ„å¤©ç„¶æ”¯æŒåŠ¨æ€æ•°æ®
- **æ›´å®æ—¶**: åœ¨çº¿æ¨ç†èƒ½åŠ›æ”¯æŒçŒæ³¨ä¸­å†³ç­–
- **æ›´æ™ºèƒ½**: GNN + LLMåŒè·¯å¾„æ¨ç†æ›´å…¨é¢
- **æ›´å¯è§£é‡Š**: çŸ¥è¯†å›¾è°±æä¾›æ¨ç†ä¾æ®

---

## é™„å½•ï¼šå®æ–½è·¯çº¿å›¾

### Phase 1: çŸ¥è¯†å›¾è°±æ‰©å±•ï¼ˆ2å‘¨ï¼‰
- [ ] æ›´æ–°Schemaï¼ˆçŒæ³¨å®ä½“/å…³ç³»ï¼‰
- [ ] æ‰©å±•LLMæŠ½å–Promptï¼ˆçŒæ³¨æ–‡çŒ®+æ“ä½œæ‰‹å†Œï¼‰
- [ ] è¿è¡ŒçŸ¥è¯†æŠ½å–ï¼ˆåŒå½“å‰æµç¨‹ï¼‰
- [ ] å¯¼å…¥Neo4jï¼ˆåŒå±‚å›¾ç»“æ„ï¼‰

### Phase 2: æ—¶åºGNNå¼€å‘ï¼ˆ3å‘¨ï¼‰
- [ ] å®ç°TemporalPerfusionGNN (LSTM + GraphSAGE)
- [ ] æ•°æ®é¢„å¤„ç†ï¼ˆè¡€æ°”/ç‚ç—‡å› å­æ—¶åºåŒ–ï¼‰
- [ ] æ¨¡å‹è®­ç»ƒï¼ˆçŒæ³¨è´¨é‡é¢„æµ‹ï¼‰
- [ ] è¯„ä¼°æŒ‡æ ‡ï¼ˆMAE, RMSE, åˆ†ç±»å‡†ç¡®ç‡ï¼‰

### Phase 3: å®æ—¶ç›‘æ§ç³»ç»Ÿï¼ˆ2å‘¨ï¼‰
- [ ] å®ç°RealTimePerfusionMonitor
- [ ] é£é™©é¢„è­¦æ¨¡å—ï¼ˆé˜ˆå€¼+è¶‹åŠ¿æ£€æµ‹ï¼‰
- [ ] ä»‹å…¥æ¨èæ¨¡å—ï¼ˆKGæ£€ç´¢+GNNé¢„æµ‹ï¼‰
- [ ] å‰ç«¯ç•Œé¢ï¼ˆå¯è§†åŒ–çŒæ³¨è¿‡ç¨‹ï¼‰

### Phase 4: é›†æˆæµ‹è¯•ï¼ˆ1å‘¨ï¼‰
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆç­–ç•¥è¾“å…¥â†’ç»“æœé¢„æµ‹â†’å®æ—¶ç›‘æ§â†’ä»‹å…¥æ¨èï¼‰
- [ ] æ¡ˆä¾‹éªŒè¯ï¼ˆå›æµ‹å†å²çŒæ³¨æ¡ˆä¾‹ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆæ¨ç†é€Ÿåº¦<1ç§’ï¼‰

**æ€»è®¡**: çº¦8å‘¨å®Œæˆæ¶æ„é€‚é…å’Œç³»ç»Ÿå¼€å‘
