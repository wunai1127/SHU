# =====================================================
# 心脏移植知识图谱自动化构建配置
# =====================================================

# LLM配置（选择一种）
llm:
  provider: "openai"  # 可选: openai, deepseek, zhipu, local

  # OpenAI配置
  openai:
    api_key: "YOUR_OPENAI_API_KEY"
    model: "gpt-4-turbo"
    base_url: "https://api.openai.com/v1"
    max_tokens: 2048
    temperature: 0.1

  # DeepSeek配置（中文优化，成本低）
  deepseek:
    api_key: "YOUR_DEEPSEEK_API_KEY"
    model: "deepseek-chat"
    base_url: "https://api.deepseek.com/v1"
    max_tokens: 2048
    temperature: 0.1

  # 本地模型配置（完全免费）
  local:
    model_path: "meta-llama/Meta-Llama-3.1-8B-Instruct"
    device: "cuda:0"
    use_8bit: true
    max_new_tokens: 2048

# 数据源配置
data:
  input_directory: "/home/user/SHU/data/medical_abstracts"
  filename_pattern: "articles_*.json"  # 支持通配符
  expected_format: "jsonl"  # json / jsonl / json.gz
  encoding: "utf-8"

  # 数据字段映射
  field_mapping:
    text_field: "abstract"  # JSON中包含摘要文本的字段名
    id_field: "pmid"        # 文章唯一标识符
    metadata_fields:        # 需要保留的元数据
      - "title"
      - "authors"
      - "journal"
      - "year"
      - "doi"

# Schema配置
schema:
  schema_file: "/home/user/SHU/schemas/chinese_medical_kg_schema.json"
  enable_schema_validation: true

  # 实体归一化配置
  normalization:
    enable_umls: false  # Phase 1不启用，避免复杂性
    enable_abbreviation_expansion: true  # PGD → Primary Graft Dysfunction
    custom_synonyms_file: "/home/user/SHU/schemas/medical_synonyms.json"

# 抽取配置
extraction:
  # 并行处理
  num_workers: 4  # 根据GPU数量调整
  batch_size: 8
  total_shards: 20  # 20000篇文章分成20个分片

  # 质量控制
  min_confidence: 0.7  # 低于此置信度的三元组将被过滤
  max_triples_per_article: 100
  enable_relation_validation: true  # 验证关系是否符合schema约束

  # 缓存策略
  enable_caching: true
  cache_directory: "/home/user/SHU/cache/extraction_cache"
  resume_from_checkpoint: true  # 支持断点续传

# Neo4j配置
neo4j:
  uri: "bolt://localhost:7687"
  username: "YOUR_NEO4J_USERNAME"
  password: "YOUR_NEO4J_PASSWORD"
  database: "heart_transplant_kg"

  # 批量导入优化
  batch_import:
    enabled: true
    batch_size: 5000  # 每批写入5000个节点/关系
    use_apoc: true    # 使用APOC插件加速

  # 索引配置（自动创建）
  indexes:
    - label: "Entity"
      properties: ["name", "type"]
    - label: "Relation"
      properties: ["type"]

  # 约束配置（自动创建）
  constraints:
    - label: "Entity"
      property: "id"
      type: "UNIQUE"

# 质量验证配置
validation:
  enable_automated_validation: true

  # 统计检查
  statistical_checks:
    min_entities_per_article: 5
    max_entities_per_article: 50
    min_relations_per_article: 3
    expected_entity_type_distribution:  # 警告阈值
      风险因子: 0.15
      并发症: 0.20
      药物: 0.10

  # 采样验证
  sampling_validation:
    sample_size: 100  # 随机抽样100个三元组人工检查
    output_file: "/home/user/SHU/validation/manual_review_samples.json"

  # 知识图谱完整性检查
  kg_integrity_checks:
    check_orphan_nodes: true  # 检查孤立节点
    check_bidirectional_relations: true  # 检查双向关系一致性
    check_temporal_consistency: true  # 检查时序关系是否有环

# 输出配置
output:
  # 中间结果
  save_intermediate_results: true
  intermediate_directory: "/home/user/SHU/output/intermediate"

  # 最终输出
  final_output_directory: "/home/user/SHU/output/final"
  generate_summary_report: true
  generate_visualization: true  # 生成KG统计可视化

  # 导出格式
  export_formats:
    - "neo4j"       # 直接写入Neo4j
    - "csv"         # 导出CSV用于备份
    - "graphml"     # 导出GraphML用于可视化工具

# 日志配置
logging:
  level: "INFO"  # DEBUG / INFO / WARNING / ERROR
  log_file: "/home/user/SHU/logs/kg_construction.log"
  enable_progress_bar: true
  enable_telegram_notification: false  # 完成后发送Telegram通知
