# APIè°ƒç”¨è¯¦ç»†è¯´æ˜ - å›ç­”æ‚¨çš„æ‹…å¿ƒ

## â“ æ‚¨çš„3ä¸ªæ‹…å¿ƒ

### 1ï¸âƒ£ "è¯·æ±‚æ¬¡æ•°é™åˆ¶æ˜¯å¦ä¼šä¸­æ–­è„šæœ¬ï¼Ÿ"

**ç­”æ¡ˆï¼šä¸ä¼šä¸­æ–­ï¼Œç³»ç»Ÿæœ‰å®Œæ•´ä¿æŠ¤æœºåˆ¶**

#### é™æµä¿æŠ¤æªæ–½

æˆ‘å·²åœ¨ `api_wrapper.py` ä¸­å®ç°äº†è‡ªåŠ¨é™æµæ§åˆ¶ï¼š

```python
# è‡ªåŠ¨é™æµï¼šæ¯æ¬¡è¯·æ±‚é—´éš” >= 1ç§’
request_interval = 60.0 / 60  # DeepSeeké™åˆ¶60è¯·æ±‚/åˆ†é’Ÿ

# å¦‚æœè¯·æ±‚è¿‡å¿«ï¼Œè‡ªåŠ¨ç­‰å¾…
if time_since_last_request < request_interval:
    sleep(request_interval - time_since_last_request)
```

#### è‡ªåŠ¨é‡è¯•æœºåˆ¶

è§¦å‘é™æµæ—¶è‡ªåŠ¨é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿ï¼š
```
ç¬¬1æ¬¡é‡è¯•: ç­‰å¾…2ç§’
ç¬¬2æ¬¡é‡è¯•: ç­‰å¾…5ç§’
ç¬¬3æ¬¡é‡è¯•: ç­‰å¾…10ç§’
ç¬¬4æ¬¡é‡è¯•: ç­‰å¾…30ç§’
ç¬¬5æ¬¡é‡è¯•: ç­‰å¾…60ç§’
```

**å®é™…æ•ˆæœ**ï¼š
- 20000ç¯‡æ–‡ç«  Ã— 1ç§’/ç¯‡ = çº¦5.5å°æ—¶ï¼ˆç†è®ºæœ€å¿«ï¼‰
- åŠ ä¸Šé‡è¯•å’Œé™æµä¿æŠ¤ = å®é™…çº¦6-8å°æ—¶
- **å…¨ç¨‹è‡ªåŠ¨ï¼Œæ— éœ€äººå·¥å¹²é¢„**

---

### 2ï¸âƒ£ "è¶…tokenæ¬ è´¹åæ˜¯å¦å¯ä»¥æ— ç¼è¡”æ¥ï¼Ÿ"

**ç­”æ¡ˆï¼šå¯ä»¥ï¼ç³»ç»Ÿæ”¯æŒæ–­ç‚¹ç»­ä¼ **

#### ä¸‰çº§ç¼“å­˜æœºåˆ¶

```
Level 1: LLMå“åº”ç¼“å­˜
  â†’ æ¯æ¬¡APIè°ƒç”¨çš„å“åº”éƒ½ä¼šä¿å­˜
  â†’ æ–‡ä»¶: cache/extraction_cache/llm_responses/{article_id}_{hash}.json
  â†’ ä½œç”¨: é¿å…é‡å¤è°ƒç”¨åŒä¸€ç¯‡æ–‡ç« 

Level 2: ä¸‰å…ƒç»„ç¼“å­˜
  â†’ è§£æåçš„ä¸‰å…ƒç»„ä¿å­˜
  â†’ æ–‡ä»¶: cache/extraction_cache/triples/{article_id}.json
  â†’ ä½œç”¨: å·²å¤„ç†çš„æ–‡ç« ä¸é‡å¤å¤„ç†

Level 3: å¯¼å…¥çŠ¶æ€ç¼“å­˜
  â†’ Neo4jå¯¼å…¥è¿›åº¦è¿½è¸ª
  â†’ æ–‡ä»¶: cache/extraction_cache/import_state.pkl
  â†’ ä½œç”¨: è®°å½•å“ªäº›æ–‡ç« å·²æˆåŠŸå¯¼å…¥
```

#### æ¢å¤æµç¨‹

**åœºæ™¯1ï¼šä½™é¢ä¸è¶³ä¸­æ–­**

```bash
# 1. ç³»ç»Ÿæ£€æµ‹åˆ°ä½™é¢ä¸è¶³ï¼Œè‡ªåŠ¨åœæ­¢
[ERROR] ä½™é¢ä¸è¶³ï¼è¯·å……å€¼åé‡æ–°è¿è¡Œ
[INFO] æç¤ºï¼šç³»ç»Ÿæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œå……å€¼åå¯ä»ä¸Šæ¬¡ä¸­æ–­å¤„ç»§ç»­

# 2. æ‚¨å……å€¼DeepSeekè´¦æˆ·

# 3. é‡æ–°è¿è¡Œè„šæœ¬ï¼ˆä½¿ç”¨ç›¸åŒé…ç½®ï¼‰
python auto_kg_builder.py --config config.yaml

# 4. ç³»ç»Ÿè‡ªåŠ¨è·³è¿‡å·²å¤„ç†çš„æ–‡ç« 
[INFO] æ£€æµ‹åˆ°ç¼“å­˜ï¼Œå·²å¤„ç† 12543 / 20000 ç¯‡æ–‡ç« 
[INFO] ä»ç¬¬ 12544 ç¯‡ç»§ç»­...
```

**åœºæ™¯2ï¼šç½‘ç»œä¸­æ–­**

ç³»ç»Ÿæ¯å¤„ç†100ç¯‡ä¿å­˜ä¸€æ¬¡è¿›åº¦ï¼Œä¸­æ–­åè‡ªåŠ¨æ¢å¤ã€‚

**åœºæ™¯3ï¼šæ‰‹åŠ¨ä¸­æ–­ï¼ˆCtrl+Cï¼‰**

```bash
# æŒ‰ Ctrl+C ä¸­æ–­
^C
[INFO] æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ­£åœ¨ä¿å­˜è¿›åº¦...
[INFO] å·²å¤„ç†: 8234 / 20000 ç¯‡
[INFO] ç¼“å­˜å·²ä¿å­˜ï¼Œä¸‹æ¬¡è¿è¡Œå°†ä»ç¬¬ 8235 ç¯‡ç»§ç»­

# ç¨åç»§ç»­
python auto_kg_builder.py --config config.yaml
[INFO] æ¢å¤ä¸Šæ¬¡è¿›åº¦ï¼Œä»ç¬¬ 8235 ç¯‡ç»§ç»­...
```

#### æˆæœ¬ä¼°ç®—ä¸ç›‘æ§

```python
# å®æ—¶æˆæœ¬ç›‘æ§ï¼ˆæ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºï¼‰
å·²å¤„ç†: 5000 / 20000 (25%)
é¢„è®¡å‰©ä½™token: ~150ä¸‡
é¢„è®¡å‰©ä½™æˆæœ¬: ~30å…ƒ
```

**å»ºè®®å……å€¼ç­–ç•¥**ï¼š
- é¦–æ¬¡å……å€¼ï¼š100å…ƒï¼ˆè¶³å¤Ÿå…¨éƒ¨20000ç¯‡ï¼‰
- ä¿å®ˆå……å€¼ï¼š50å…ƒ â†’ å¤„ç†çº¦10000ç¯‡ â†’ å†å……50å…ƒ

---

### 3ï¸âƒ£ "APIè°ƒç”¨å®Œæˆçš„æ˜¯å“ªéƒ¨åˆ†å†…å®¹ï¼Ÿ"

**ç­”æ¡ˆï¼šAPIåªè´Ÿè´£çŸ¥è¯†æŠ½å–ï¼Œå…¶ä»–éƒ½æ˜¯æœ¬åœ°å¤„ç†**

#### å®Œæ•´æµæ°´çº¿åˆ†è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥: 20000ç¯‡åŒ»å­¦æ–‡çŒ® JSON                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
    â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1 â”‚    â”‚ Step 2 â”‚    â”‚ Step 3 â”‚
â”‚ æœ¬åœ°   â”‚    â”‚  API   â”‚    â”‚ æœ¬åœ°   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: æ•°æ®åŠ è½½ï¼ˆæœ¬åœ°ï¼Œç§’çº§ï¼‰
  â”œâ”€ è¯»å–JSONæ–‡ä»¶
  â”œâ”€ å­—æ®µéªŒè¯
  â””â”€ æ•°æ®æ¸…æ´—

Step 2: çŸ¥è¯†æŠ½å–ï¼ˆAPIè°ƒç”¨ï¼Œ5-8å°æ—¶ï¼‰â† å”¯ä¸€ä½¿ç”¨APIçš„æ­¥éª¤
  â”œâ”€ LLMåˆ†ææ–‡æœ¬
  â”œâ”€ æå–å®ä½“ï¼ˆä¾›ä½“ç‰¹å¾ã€é£é™©å› å­ç­‰ï¼‰
  â”œâ”€ æå–å…³ç³»ï¼ˆå¯¼è‡´ã€å¢åŠ é£é™©ç­‰ï¼‰
  â””â”€ æå–ç»Ÿè®¡é‡ï¼ˆä¼˜åŠ¿æ¯”ã€På€¼ï¼‰

Step 3: åå¤„ç†ï¼ˆæœ¬åœ°ï¼Œåˆ†é’Ÿçº§ï¼‰
  â”œâ”€ SchemaéªŒè¯
  â”œâ”€ å®ä½“å»é‡å’Œå½’ä¸€åŒ–
  â”œâ”€ åŒä¹‰è¯æ˜ å°„ï¼ˆPGD â†’ åŸå‘æ€§ç§»æ¤ç‰©åŠŸèƒ½éšœç¢ï¼‰
  â”œâ”€ è´¨é‡è¿‡æ»¤ï¼ˆç½®ä¿¡åº¦ < 0.7 çš„ä¸‰å…ƒç»„ä¸¢å¼ƒï¼‰
  â””â”€ æ‰¹é‡å¯¼å…¥Neo4j

Step 4: è´¨é‡éªŒè¯ï¼ˆæœ¬åœ°ï¼Œåˆ†é’Ÿçº§ï¼‰
  â”œâ”€ ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
  â”œâ”€ é‡‡æ ·100ä¸ªä¸‰å…ƒç»„ä¾›äººå·¥æ£€æŸ¥
  â””â”€ å¯è§†åŒ–ç”Ÿæˆ
```

#### APIè°ƒç”¨çš„å…·ä½“å†…å®¹

**å•ç¯‡æ–‡ç« çš„APIè°ƒç”¨ç¤ºä¾‹**ï¼š

```
è¾“å…¥æ–‡æœ¬ â†’
  "Background: Prolonged ischemic time is a major risk factor
   for primary graft dysfunction (PGD)... Results: PGD incidence
   was 25.2% vs 12.3% (p<0.001, OR 2.3, 95% CI 1.5-3.5)..."

APIè°ƒç”¨ï¼ˆLLMå¤„ç†ï¼‰â†’
  Prompt: "è¯·ä»ä»¥ä¸‹åŒ»å­¦æ‘˜è¦ä¸­æŠ½å–å®ä½“å’Œå…³ç³»..."

APIè¿”å› â†’
  [
    {
      "type": "entity",
      "name": "å»¶é•¿ç¼ºè¡€æ—¶é—´",
      "entity_type": "é£é™©å› å­",
      "properties": {"é£é™©ç­‰çº§": "é«˜"}
    },
    {
      "type": "entity",
      "name": "åŸå‘æ€§ç§»æ¤ç‰©åŠŸèƒ½éšœç¢",
      "entity_type": "å¹¶å‘ç—‡",
      "properties": {"å‘ç”Ÿç‡": "25.2%"}
    },
    {
      "type": "relation",
      "head": "å»¶é•¿ç¼ºè¡€æ—¶é—´",
      "relation_type": "å¯¼è‡´",
      "tail": "åŸå‘æ€§ç§»æ¤ç‰©åŠŸèƒ½éšœç¢",
      "properties": {
        "è¯æ®å¼ºåº¦": "RCT",
        "ä¼˜åŠ¿æ¯”": 2.3,
        "På€¼": 0.001
      }
    }
  ]

æœ¬åœ°å¤„ç† â†’
  â”œâ”€ åŒä¹‰è¯æ˜ å°„: "PGD" â†’ "åŸå‘æ€§ç§»æ¤ç‰©åŠŸèƒ½éšœç¢"
  â”œâ”€ SchemaéªŒè¯: âœ“ "å¯¼è‡´"å…³ç³»åˆæ³•
  â”œâ”€ è´¨é‡è¿‡æ»¤: âœ“ åŒ…å«ç»Ÿè®¡é‡ï¼Œä¿ç•™
  â””â”€ å­˜å…¥ç¼“å­˜: cache/triples/PMID12345678.json
```

#### Tokenæ¶ˆè€—ä¼°ç®—

| ç»„æˆéƒ¨åˆ† | Tokenæ•° | è¯´æ˜ |
|---------|---------|------|
| **è¾“å…¥** | ~500 token/ç¯‡ | æ‘˜è¦æ–‡æœ¬ + Prompt |
| **è¾“å‡º** | ~300 token/ç¯‡ | LLMè¿”å›çš„JSONä¸‰å…ƒç»„ |
| **æ€»è®¡** | ~800 token/ç¯‡ | Ã— 20000 = 1600ä¸‡ token |

**æˆæœ¬è®¡ç®—**ï¼ˆDeepSeekä»·æ ¼ï¼š0.001å…ƒ/1K tokenï¼‰ï¼š
```
æ€»Token: 1600ä¸‡
æ€»æˆæœ¬: 1600ä¸‡ Ã· 1000 Ã— 0.001å…ƒ = 16å…ƒ
å®é™…æˆæœ¬: ~50å…ƒï¼ˆè€ƒè™‘é‡è¯•å’Œé¢å¤–è°ƒç”¨ï¼‰
```

---

## âœ… æ€»ç»“ï¼šæ‚¨çš„æ‹…å¿ƒéƒ½æœ‰è§£å†³æ–¹æ¡ˆ

| æ‹…å¿ƒ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|------|---------|------|
| **é™æµä¸­æ–­** | è‡ªåŠ¨é—´éš”æ§åˆ¶ + æŒ‡æ•°é€€é¿é‡è¯• | âœ… å·²å®ç° |
| **æ¬ è´¹ä¸­æ–­** | ä¸‰çº§ç¼“å­˜ + æ–­ç‚¹ç»­ä¼  | âœ… å·²å®ç° |
| **æˆæœ¬è¶…é¢„æœŸ** | å®æ—¶ç›‘æ§ + ç²¾ç¡®ä¼°ç®—ï¼ˆ~50å…ƒï¼‰ | âœ… å·²å®ç° |
| **APIåšä»€ä¹ˆ** | ä»…çŸ¥è¯†æŠ½å–ï¼Œå…¶ä»–éƒ½æ˜¯æœ¬åœ°å¤„ç† | âœ… å·²è¯´æ˜ |

---

## ğŸš€ æ¨èè¿è¡Œæµç¨‹

### ç¨³å¦¥æ–¹æ¡ˆï¼ˆæ¨èï¼‰

```bash
# Step 1: å°è§„æ¨¡æµ‹è¯•ï¼ˆ10ç¯‡æ–‡ç« ï¼Œæˆæœ¬<0.5å…ƒï¼‰
python auto_kg_builder.py --config config.yaml --test-mode --max-articles 10

# éªŒè¯è¾“å‡ºè´¨é‡
# æŸ¥çœ‹: output/intermediate/triples_shard_0.json

# Step 2: ä¸­ç­‰è§„æ¨¡æµ‹è¯•ï¼ˆ1000ç¯‡ï¼Œæˆæœ¬~2.5å…ƒï¼‰
python auto_kg_builder.py --config config.yaml --max-articles 1000

# éªŒè¯Neo4jå¯¼å…¥æˆåŠŸ
# è®¿é—®: http://localhost:7474

# Step 3: å…¨é‡è¿è¡Œï¼ˆ20000ç¯‡ï¼Œæˆæœ¬~50å…ƒï¼‰
python auto_kg_builder.py --config config.yaml
```

### æ¿€è¿›æ–¹æ¡ˆï¼ˆä¸€æ¬¡æ€§å…¨é‡ï¼‰

```bash
# ç›´æ¥è¿è¡Œå…¨éƒ¨20000ç¯‡
python auto_kg_builder.py --config config.yaml

# å³ä½¿ä¸­æ–­ä¹Ÿèƒ½æ¢å¤ï¼Œæ‰€ä»¥ä¹ŸOK
```

---

## ğŸ“Š è¿è¡ŒæœŸé—´çš„ç›‘æ§

ç³»ç»Ÿä¼šå®æ—¶æ˜¾ç¤ºï¼š

```
========================================
çŸ¥è¯†æŠ½å–è¿›åº¦
========================================
å·²å¤„ç†: 5234 / 20000 (26.2%)
å½“å‰é€Ÿåº¦: 1.2 ç¯‡/ç§’
é¢„è®¡å‰©ä½™æ—¶é—´: 3å°æ—¶42åˆ†é’Ÿ

ç»Ÿè®¡:
  - å®ä½“æŠ½å–: 145,678 ä¸ª
  - å…³ç³»æŠ½å–: 267,890 ä¸ª
  - è·³è¿‡ï¼ˆä½è´¨é‡ï¼‰: 234 ä¸ª
  - APIé‡è¯•æ¬¡æ•°: 12

æˆæœ¬ä¼°ç®—:
  - å·²æ¶ˆè€—Token: 418ä¸‡
  - é¢„è®¡æ€»Token: 1600ä¸‡
  - é¢„è®¡æ€»æˆæœ¬: 48å…ƒ
========================================
```

---

## ğŸ’¡ åº”å¯¹çªå‘æƒ…å†µ

### åœºæ™¯1: è¿è¡Œä¸­ä½™é¢ä¸è¶³

```
[ERROR] APIè°ƒç”¨å¤±è´¥: insufficient balance
[INFO] å·²å¤„ç† 12543 ç¯‡ï¼Œç¼“å­˜å·²ä¿å­˜
[INFO] è¯·å……å€¼åè¿è¡Œç›¸åŒå‘½ä»¤ç»§ç»­

â†’ æ‚¨å……å€¼ â†’ é‡æ–°è¿è¡Œè„šæœ¬ â†’ è‡ªåŠ¨ä»ç¬¬12544ç¯‡ç»§ç»­
```

### åœºæ™¯2: ç½‘ç»œä¸ç¨³å®š

```
[WARNING] APIè¶…æ—¶ï¼Œç¬¬1æ¬¡é‡è¯•ï¼Œç­‰å¾…2ç§’
[WARNING] APIè¶…æ—¶ï¼Œç¬¬2æ¬¡é‡è¯•ï¼Œç­‰å¾…5ç§’
[INFO] é‡è¯•æˆåŠŸ

â†’ ç³»ç»Ÿè‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€äººå·¥å¹²é¢„
```

### åœºæ™¯3: ä¸­é€”æƒ³æŸ¥çœ‹è¿›åº¦

```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f logs/kg_construction.log

# æŸ¥çœ‹å·²å¤„ç†æ–‡ç« æ•°
ls cache/extraction_cache/triples/ | wc -l
```

---

**æ‚¨ç°åœ¨å¯ä»¥æ”¾å¿ƒè¿è¡Œäº†ï¼** ğŸš€

æ‰€æœ‰é£é™©éƒ½æœ‰ä¿æŠ¤æœºåˆ¶ï¼Œæˆæœ¬å¯æ§ä¸”é€æ˜ã€‚
